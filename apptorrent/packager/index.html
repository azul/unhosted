<html><head>
<script src="../runTimeEnv/plannerApp.apptorrent"></script>
<script src="jQuery.js"></script>
<script src="syncStorage4.js"></script>
<script src="webtoolkit.sha1.js"></script>
<script src="htmlparser.js"></script>
<script>
function fillFields() {
  document.getElementById('html').innerHTML=appTorrent.html
  for(var i=0; i< appTorrent.css.length; i++) {
    document.getElementById('css').innerHTML+=appTorrent.css[i]
  }
  document.getElementById('js').innerHTML=appTorrent.js
}

var pkg = {}
var pendingFiles = 0
function globalDone() {
  finishPackage(pkg)
}
function getFile(fileName, cb) {
  pendingFiles++
  $.ajax(
    { url: document.getElementById('original').value + fileName
    , success: function(data) {
        cb(data)
        pendingFiles--
        if(pendingFiles == 0) {
          globalDone()
        }
      }
    }
  )
}

function package() {
  getFile('index.html', parseOpa)
}

function parseOpa(data) {
  try {
    //hack 1: get rid of DOCTYPE:
    data = data.substring(17)
    //hack 2a: get rid of &...; html tags:
    dataBits = data.split('&')
    data = ''
    for(var i in dataBits) {
      data += dataBits[i]
      if(i < (dataBits.length-1)) {
        data +='_AMPERSAND_'
      }
    }
    //get OPA and parse HTML into <head> and <body>:
    xmlText = HTMLtoXML(data)
    var xmlTree = (new DOMParser()).parseFromString(xmlText, 'text/xml')
    //get pkg.html:
    pkg.html = (new XMLSerializer()).serializeToString(xmlTree.getElementsByTagName('body')[0])
    //hack 2b: put &...; html tags back:
    var bits = pkg.html.split('_AMPERSAND_')
    pkg.html = ''
    for(var i in bits) {
      pkg.html += bits[i]
      if(i < (bits.length-1)) {
        pkg.html +='&'
      }
    }
    //get pkg.css:
    var links = xmlTree.getElementsByTagName('link')
    pkg.css = ''
    for(var i in links) {
      var attr = links[i].attributes
      for(var j in attr) {
        if(attr[j].name == 'rel' && attr[j].value == 'stylesheet') { 
          for(var k in attr) {
            if(attr[k].name == 'href') {
              getFile(attr[k].value, function(data) {
                pkg.css += data 
              })
              break
            }
          }
          break
        }
      }
    }
    //get pkg.js:
    var scriptTags = xmlTree.getElementsByTagName('script')
    pkg.js = ''
    for(var i in scriptTags) {
      var attr = scriptTags[i].attributes
      for(var j in attr) {
        if(attr[j].name == 'src') { 
          getFile(attr[j].value, function(data) {
            pkg.js += data
          })
          break
        }
      }
    }
  } catch(e) {
    alert('html parse fail! sorry...')
  }
}

function finishPackage(pkg) {
  pkg.title = document.getElementById('title').value
  pkg.description = document.getElementById('description').value
  pkg.author = document.getElementById('author').value
  pkg.original = document.getElementById('original').value
  pkg.license = document.getElementById('license').value
  pkg.packager = document.getElementById('packager').value
  var sausage = JSON.stringify(pkg)
  var sha1 = SHA1(sausage)
  localStorage.setItem(sha1, sausage)
  document.getElementById('result').innerHTML = "Unhosted web app packaged as <strong>apptorrent://"+sha1+"/</strong>"
}
</script></head><body onload="fillFields()">
<H1>Package a localStorage-based HTML app, and unhost it on apptorrent!</H1>
<input type="submit" onclick="package()">
<div id="result"></div>
Fill in stuff here:
<H2>Basic Info:</H2>
<label>Title:</label><input id="title" type="text" size="100"  value="Simple Planner">
<br><label>Description:</label><input id="description" size="100" type="text" value="A localStorage based personal planner prototype. Made for 10K Apart">
<br><label>Author:</label><input id="author" type="text" size="100"  value="Kailash Nadh, http://kailashnadh.name (August 2011)">
<br><label>Original:</label><input id="original" type="text" size="100"  value="http://example.com/unhosted/apptorrent/plannerAppOrig/">
<br><label>License:</label><input id="license" type="text" size="100"  value="GPL">
<br><label>Packager:</label><input id="packager" type="text" size="100"  value="Michiel de Jong">

<H2>HTML5 Body:</H2>
<textarea id="html"></textarea>
<H2>CSS3 Rules:</H2>
<textarea id="css"></textarea>
<H2>JavaScript:</H2>
<textarea id="js"></textarea>
<H2>Libs:</H2>
<textarea id="libs"></textarea>
</body></html>
