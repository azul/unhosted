<html><head>
<script>syncStorageScope='apptorrent'</script>
<script src="https://browserid.org/include.js"></script>
<script src="../jQuery.js"></script>
<script src="../syncStorage4.js"></script>
<script src="webtoolkit.sha1.js"></script>
<script src="htmlparser.js"></script>
<script>

var pkg = {}
var pendingFiles = 0
function globalDone() {
  finishPackage(pkg)
}
function getFile(fileName, cb) {
  pendingFiles++
  $.ajax(
    { url: document.getElementById('original').value + fileName
    , success: function(data) {
        cb(fileName, data)
        pendingFiles--
        if(pendingFiles == 0) {
          globalDone()
        }
      }
    }
  )
}

function package() {
  if(/Firefox[\/\s](\d+\.\d+)/.test(navigator.userAgent)) {
    if(navigator.id.sessions) {
//      if(navigator.id.sessions.length) {
        getFile('index.html', parseOpa)
//      } else {
//        alert('please sign in first')
//      }
    } else {
      alert('please install https://github.com/mozilla/browserid_addon/raw/develop/addon/dist/browserid_addon.xpi first to make this demo work')
    }
  } else {
    alert('please use firefox for now, other browsers coming soon')
  }
}

function createDocument(html, title) {
  var doc = document.implementation.createHTMLDocument (title)
  doc.documentElement.innerHTML = html
  return doc
}

function parseOpa(fileName, data) {
  try {

    //get OPA and parse HTML into <head> and <body>:
    var d = createDocument(data)
    pkg.html = d.getElementsByTagName('body')[0].innerHTML

    pkg.title = d.getElementsByTagName('title')[0].childNodes[0].nodeValue
    //pkg.author = d.getElementsByTagName('author')[0].childNodes[0].nodeValue - should automatically add flattr button

    //get pkg.css:
    var links = d.getElementsByTagName('link')
    pkg.css = {}
    for(var i in links) {
      var attr = links[i].attributes
      for(var j in attr) {
        if(attr[j].name == 'rel' && attr[j].value == 'stylesheet') { 
          for(var k in attr) {
            if(attr[k].name == 'href') {
              pkg.css[attr[k].value] = false//reserve place in sheets order
              getFile(attr[k].value, function(fileName, data) {
                pkg.css[fileName] = data 
              })
              break
            }
          }
          break
        }
      }
    }
    //get pkg.js:
    var scriptTags = d.getElementsByTagName('script')
    pkg.js = {}
    for(var i in scriptTags) {
      var attr = scriptTags[i].attributes
      for(var j in attr) {
        if(attr[j].name == 'src') { 
          pkg.js[attr[j].value] = false//reserve place in scripts order
          getFile(attr[j].value, function(fileName, data) {
            pkg.js[fileName] = data
          })
          break
        }
      }
    }
  } catch(e) {
    alert('html parse fail! sorry...')
  }
}

function finishPackage(pkg) {
  pkg.original = document.getElementById('original').value
  var sausage = JSON.stringify(pkg)
  var sha1 = SHA1(sausage)
  syncStorage.setItem(sha1, sausage)//this will set the sausage into localStorage, and sync it to remote storage if one is connected
  document.getElementById('result').innerHTML = 
    'Unhosted web app packaged as <strong><a target="_blank" '
    +'href="http://'+sha1+'.apptorrent.net/unhosted/apptorrent/player/player.html?peer=mich@yourremotestorage.com">'
    +'apptorrent://mich@yourremotestorage.com/'+sha1+'</a></strong>'
}
</script></head><body>
<H1>Package a localStorage-based HTML app, and unhost it on apptorrent!</H1>
<input type="submit" onclick="package()">
<div id="result"></div>
<br><label>Original:</label><input id="original" type="text" size="100"  value="http://example.com/unhosted/apptorrent/backboneTodoBeforeMarshall/">
</body></html>
